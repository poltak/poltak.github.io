import{d as lt,e as ts,b as D,a as A}from"../chunks/3wy9VqJr.js";import"../chunks/pjcxXySh.js";import{v as T,T as ct,a3 as dt,G as ss,bg as ns,a1 as ut,Z as is,_ as os,b5 as rs,b0 as as,D as ls,a0 as cs,Y as oe,bh as ht,bi as ft,bj as ds,aC as us,aI as hs,bc as Te,bd as fs,aE as x,x as pt,o as y,g as s,aD as ps,R as I,j as vs,C as f,aH as _s,w as re,q as b,bk as Ee,d as F}from"../chunks/DEdbc7eF.js";import{h as gs,a as ms,s as L}from"../chunks/C8FaYV1O.js";import{i as R}from"../chunks/CeRQR2up.js";import{e as Ve,i as vt}from"../chunks/DhHPHEYA.js";import{h as ws}from"../chunks/DIdsJkK3.js";import{r as bs,a as Le}from"../chunks/CzaEsoBq.js";import{e as $}from"../chunks/B2bP0puB.js";import{a as xs}from"../chunks/B_BqdAm4.js";import{b as Ae}from"../chunks/jzo4OWF3.js";import{b as ys}from"../chunks/aEJhf3-I.js";import{i as Ss}from"../chunks/4qslejAf.js";import{p as _t}from"../chunks/-fCvwRfS.js";function ks(o,e,t){if(!e||e===gs(String(t??"")))return;let n;const i=o.__svelte_meta?.loc;i?n=`near ${i.file}:${i.line}:${i.column}`:ht?.[ft]&&(n=`in ${ht[ft]}`),ds(ms(n))}function zs(o,e,t=!1,n=!1,i=!1){var r=o,d="";T(()=>{var u=ss;if(d===(d=e()??"")){ct&&dt();return}if(u.nodes!==null&&(ns(u.nodes.start,u.nodes.end),u.nodes=null),d!==""){if(ct){for(var h=ut.data,c=dt(),p=c;c!==null&&(c.nodeType!==is||c.data!=="");)p=c,c=os(c);if(c===null)throw rs(),as;ls&&!i&&ks(c.parentNode,h,d),lt(ut,p),r=cs(c);return}var w=d+"";t?w=`<svg>${w}</svg>`:n&&(w=`<math>${w}</math>`);var _=ts(w);if((t||n)&&(_=oe(_)),lt(oe(_),_.lastChild),t||n)for(;oe(_);)r.before(oe(_));else r.before(_)}})}const Is=()=>({fun:{title:"Kindle Clippings Viewer",description:'Upload a Kindle "My Clippings.txt" file and browse highlights by book or author.'}}),hn=Object.freeze(Object.defineProperty({__proto__:null,load:Is},Symbol.toStringTag,{value:"Module"})),Fs="ENTRIES",xt="KEYS",yt="VALUES",O="";class De{constructor(e,t){const n=e._tree,i=Array.from(n.keys());this.set=e,this._type=t,this._path=i.length>0?[{node:n,keys:i}]:[]}next(){const e=this.dive();return this.backtrack(),e}dive(){if(this._path.length===0)return{done:!0,value:void 0};const{node:e,keys:t}=Y(this._path);if(Y(t)===O)return{done:!1,value:this.result()};const n=e.get(Y(t));return this._path.push({node:n,keys:Array.from(n.keys())}),this.dive()}backtrack(){if(this._path.length===0)return;const e=Y(this._path).keys;e.pop(),!(e.length>0)&&(this._path.pop(),this.backtrack())}key(){return this.set._prefix+this._path.map(({keys:e})=>Y(e)).filter(e=>e!==O).join("")}value(){return Y(this._path).node.get(O)}result(){switch(this._type){case yt:return this.value();case xt:return this.key();default:return[this.key(),this.value()]}}[Symbol.iterator](){return this}}const Y=o=>o[o.length-1],Cs=(o,e,t)=>{const n=new Map;if(e===void 0)return n;const i=e.length+1,r=i+t,d=new Uint8Array(r*i).fill(t+1);for(let u=0;u<i;++u)d[u]=u;for(let u=1;u<r;++u)d[u*i]=u;return St(o,e,t,n,d,1,i,""),n},St=(o,e,t,n,i,r,d,u)=>{const h=r*d;e:for(const c of o.keys())if(c===O){const p=i[h-1];p<=t&&n.set(u,[o.get(c),p])}else{let p=r;for(let w=0;w<c.length;++w,++p){const _=c[w],S=d*p,k=S-d;let m=i[S];const g=Math.max(0,p-t-1),M=Math.min(d-1,p+t);for(let q=g;q<M;++q){const N=_!==e[q],U=i[k+q]+ +N,W=i[k+q+1]+1,j=i[S+q]+1,B=i[S+q+1]=Math.min(U,W,j);B<m&&(m=B)}if(m>t)continue e}St(o.get(c),e,t,n,i,p,d,u+c)}};class J{constructor(e=new Map,t=""){this._size=void 0,this._tree=e,this._prefix=t}atPrefix(e){if(!e.startsWith(this._prefix))throw new Error("Mismatched prefix");const[t,n]=ce(this._tree,e.slice(this._prefix.length));if(t===void 0){const[i,r]=Be(n);for(const d of i.keys())if(d!==O&&d.startsWith(r)){const u=new Map;return u.set(d.slice(r.length),i.get(d)),new J(u,e)}}return new J(t,e)}clear(){this._size=void 0,this._tree.clear()}delete(e){return this._size=void 0,Ms(this._tree,e)}entries(){return new De(this,Fs)}forEach(e){for(const[t,n]of this)e(t,n,this)}fuzzyGet(e,t){return Cs(this._tree,e,t)}get(e){const t=Pe(this._tree,e);return t!==void 0?t.get(O):void 0}has(e){const t=Pe(this._tree,e);return t!==void 0&&t.has(O)}keys(){return new De(this,xt)}set(e,t){if(typeof e!="string")throw new Error("key must be a string");return this._size=void 0,Ne(this._tree,e).set(O,t),this}get size(){if(this._size)return this._size;this._size=0;const e=this.entries();for(;!e.next().done;)this._size+=1;return this._size}update(e,t){if(typeof e!="string")throw new Error("key must be a string");this._size=void 0;const n=Ne(this._tree,e);return n.set(O,t(n.get(O))),this}fetch(e,t){if(typeof e!="string")throw new Error("key must be a string");this._size=void 0;const n=Ne(this._tree,e);let i=n.get(O);return i===void 0&&n.set(O,i=t()),i}values(){return new De(this,yt)}[Symbol.iterator](){return this.entries()}static from(e){const t=new J;for(const[n,i]of e)t.set(n,i);return t}static fromObject(e){return J.from(Object.entries(e))}}const ce=(o,e,t=[])=>{if(e.length===0||o==null)return[o,t];for(const n of o.keys())if(n!==O&&e.startsWith(n))return t.push([o,n]),ce(o.get(n),e.slice(n.length),t);return t.push([o,e]),ce(void 0,"",t)},Pe=(o,e)=>{if(e.length===0||o==null)return o;for(const t of o.keys())if(t!==O&&e.startsWith(t))return Pe(o.get(t),e.slice(t.length))},Ne=(o,e)=>{const t=e.length;e:for(let n=0;o&&n<t;){for(const r of o.keys())if(r!==O&&e[n]===r[0]){const d=Math.min(t-n,r.length);let u=1;for(;u<d&&e[n+u]===r[u];)++u;const h=o.get(r);if(u===r.length)o=h;else{const c=new Map;c.set(r.slice(u),h),o.set(e.slice(n,n+u),c),o.delete(r),o=c}n+=u;continue e}const i=new Map;return o.set(e.slice(n),i),i}return o},Ms=(o,e)=>{const[t,n]=ce(o,e);if(t!==void 0){if(t.delete(O),t.size===0)kt(n);else if(t.size===1){const[i,r]=t.entries().next().value;zt(n,i,r)}}},kt=o=>{if(o.length===0)return;const[e,t]=Be(o);if(e.delete(t),e.size===0)kt(o.slice(0,-1));else if(e.size===1){const[n,i]=e.entries().next().value;n!==O&&zt(o.slice(0,-1),n,i)}},zt=(o,e,t)=>{if(o.length===0)return;const[n,i]=Be(o);n.set(i+e,t),n.delete(i)},Be=o=>o[o.length-1],Je="or",It="and",qs="and_not";class Q{constructor(e){if(e?.fields==null)throw new Error('MiniSearch: option "fields" must be provided');const t=e.autoVacuum==null||e.autoVacuum===!0?je:e.autoVacuum;this._options={...Ue,...e,autoVacuum:t,searchOptions:{...gt,...e.searchOptions||{}},autoSuggestOptions:{...Ls,...e.autoSuggestOptions||{}}},this._index=new J,this._documentCount=0,this._documentIds=new Map,this._idToShortId=new Map,this._fieldIds={},this._fieldLength=new Map,this._avgFieldLength=[],this._nextId=0,this._storedFields=new Map,this._dirtCount=0,this._currentVacuum=null,this._enqueuedVacuum=null,this._enqueuedVacuumConditions=We,this.addFields(this._options.fields)}add(e){const{extractField:t,stringifyField:n,tokenize:i,processTerm:r,fields:d,idField:u}=this._options,h=t(e,u);if(h==null)throw new Error(`MiniSearch: document does not have ID field "${u}"`);if(this._idToShortId.has(h))throw new Error(`MiniSearch: duplicate ID ${h}`);const c=this.addDocumentId(h);this.saveStoredFields(c,e);for(const p of d){const w=t(e,p);if(w==null)continue;const _=i(n(w,p),p),S=this._fieldIds[p],k=new Set(_).size;this.addFieldLength(c,S,this._documentCount-1,k);for(const m of _){const g=r(m,p);if(Array.isArray(g))for(const M of g)this.addTerm(S,c,M);else g&&this.addTerm(S,c,g)}}}addAll(e){for(const t of e)this.add(t)}addAllAsync(e,t={}){const{chunkSize:n=10}=t,i={chunk:[],promise:Promise.resolve()},{chunk:r,promise:d}=e.reduce(({chunk:u,promise:h},c,p)=>(u.push(c),(p+1)%n===0?{chunk:[],promise:h.then(()=>new Promise(w=>setTimeout(w,0))).then(()=>this.addAll(u))}:{chunk:u,promise:h}),i);return d.then(()=>this.addAll(r))}remove(e){const{tokenize:t,processTerm:n,extractField:i,stringifyField:r,fields:d,idField:u}=this._options,h=i(e,u);if(h==null)throw new Error(`MiniSearch: document does not have ID field "${u}"`);const c=this._idToShortId.get(h);if(c==null)throw new Error(`MiniSearch: cannot remove document with ID ${h}: it is not in the index`);for(const p of d){const w=i(e,p);if(w==null)continue;const _=t(r(w,p),p),S=this._fieldIds[p],k=new Set(_).size;this.removeFieldLength(c,S,this._documentCount,k);for(const m of _){const g=n(m,p);if(Array.isArray(g))for(const M of g)this.removeTerm(S,c,M);else g&&this.removeTerm(S,c,g)}}this._storedFields.delete(c),this._documentIds.delete(c),this._idToShortId.delete(h),this._fieldLength.delete(c),this._documentCount-=1}removeAll(e){if(e)for(const t of e)this.remove(t);else{if(arguments.length>0)throw new Error("Expected documents to be present. Omit the argument to remove all documents.");this._index=new J,this._documentCount=0,this._documentIds=new Map,this._idToShortId=new Map,this._fieldLength=new Map,this._avgFieldLength=[],this._storedFields=new Map,this._nextId=0}}discard(e){const t=this._idToShortId.get(e);if(t==null)throw new Error(`MiniSearch: cannot discard document with ID ${e}: it is not in the index`);this._idToShortId.delete(e),this._documentIds.delete(t),this._storedFields.delete(t),(this._fieldLength.get(t)||[]).forEach((n,i)=>{this.removeFieldLength(t,i,this._documentCount,n)}),this._fieldLength.delete(t),this._documentCount-=1,this._dirtCount+=1,this.maybeAutoVacuum()}maybeAutoVacuum(){if(this._options.autoVacuum===!1)return;const{minDirtFactor:e,minDirtCount:t,batchSize:n,batchWait:i}=this._options.autoVacuum;this.conditionalVacuum({batchSize:n,batchWait:i},{minDirtCount:t,minDirtFactor:e})}discardAll(e){const t=this._options.autoVacuum;try{this._options.autoVacuum=!1;for(const n of e)this.discard(n)}finally{this._options.autoVacuum=t}this.maybeAutoVacuum()}replace(e){const{idField:t,extractField:n}=this._options,i=n(e,t);this.discard(i),this.add(e)}vacuum(e={}){return this.conditionalVacuum(e)}conditionalVacuum(e,t){return this._currentVacuum?(this._enqueuedVacuumConditions=this._enqueuedVacuumConditions&&t,this._enqueuedVacuum!=null?this._enqueuedVacuum:(this._enqueuedVacuum=this._currentVacuum.then(()=>{const n=this._enqueuedVacuumConditions;return this._enqueuedVacuumConditions=We,this.performVacuuming(e,n)}),this._enqueuedVacuum)):this.vacuumConditionsMet(t)===!1?Promise.resolve():(this._currentVacuum=this.performVacuuming(e),this._currentVacuum)}async performVacuuming(e,t){const n=this._dirtCount;if(this.vacuumConditionsMet(t)){const i=e.batchSize||Re.batchSize,r=e.batchWait||Re.batchWait;let d=1;for(const[u,h]of this._index){for(const[c,p]of h)for(const[w]of p)this._documentIds.has(w)||(p.size<=1?h.delete(c):p.delete(w));this._index.get(u).size===0&&this._index.delete(u),d%i===0&&await new Promise(c=>setTimeout(c,r)),d+=1}this._dirtCount-=n}await null,this._currentVacuum=this._enqueuedVacuum,this._enqueuedVacuum=null}vacuumConditionsMet(e){if(e==null)return!0;let{minDirtCount:t,minDirtFactor:n}=e;return t=t||je.minDirtCount,n=n||je.minDirtFactor,this.dirtCount>=t&&this.dirtFactor>=n}get isVacuuming(){return this._currentVacuum!=null}get dirtCount(){return this._dirtCount}get dirtFactor(){return this._dirtCount/(1+this._documentCount+this._dirtCount)}has(e){return this._idToShortId.has(e)}getStoredFields(e){const t=this._idToShortId.get(e);if(t!=null)return this._storedFields.get(t)}search(e,t={}){const{searchOptions:n}=this._options,i={...n,...t},r=this.executeQuery(e,t),d=[];for(const[u,{score:h,terms:c,match:p}]of r){const w=c.length||1,_={id:this._documentIds.get(u),score:h*w,terms:Object.keys(p),queryTerms:c,match:p};Object.assign(_,this._storedFields.get(u)),(i.filter==null||i.filter(_))&&d.push(_)}return e===Q.wildcard&&i.boostDocument==null||d.sort(wt),d}autoSuggest(e,t={}){t={...this._options.autoSuggestOptions,...t};const n=new Map;for(const{score:r,terms:d}of this.search(e,t)){const u=d.join(" "),h=n.get(u);h!=null?(h.score+=r,h.count+=1):n.set(u,{score:r,terms:d,count:1})}const i=[];for(const[r,{score:d,terms:u,count:h}]of n)i.push({suggestion:r,terms:u,score:d/h});return i.sort(wt),i}get documentCount(){return this._documentCount}get termCount(){return this._index.size}static loadJSON(e,t){if(t==null)throw new Error("MiniSearch: loadJSON should be given the same options used when serializing the index");return this.loadJS(JSON.parse(e),t)}static async loadJSONAsync(e,t){if(t==null)throw new Error("MiniSearch: loadJSON should be given the same options used when serializing the index");return this.loadJSAsync(JSON.parse(e),t)}static getDefault(e){if(Ue.hasOwnProperty(e))return $e(Ue,e);throw new Error(`MiniSearch: unknown option "${e}"`)}static loadJS(e,t){const{index:n,documentIds:i,fieldLength:r,storedFields:d,serializationVersion:u}=e,h=this.instantiateMiniSearch(e,t);h._documentIds=ae(i),h._fieldLength=ae(r),h._storedFields=ae(d);for(const[c,p]of h._documentIds)h._idToShortId.set(p,c);for(const[c,p]of n){const w=new Map;for(const _ of Object.keys(p)){let S=p[_];u===1&&(S=S.ds),w.set(parseInt(_,10),ae(S))}h._index.set(c,w)}return h}static async loadJSAsync(e,t){const{index:n,documentIds:i,fieldLength:r,storedFields:d,serializationVersion:u}=e,h=this.instantiateMiniSearch(e,t);h._documentIds=await le(i),h._fieldLength=await le(r),h._storedFields=await le(d);for(const[p,w]of h._documentIds)h._idToShortId.set(w,p);let c=0;for(const[p,w]of n){const _=new Map;for(const S of Object.keys(w)){let k=w[S];u===1&&(k=k.ds),_.set(parseInt(S,10),await le(k))}++c%1e3===0&&await Ft(0),h._index.set(p,_)}return h}static instantiateMiniSearch(e,t){const{documentCount:n,nextId:i,fieldIds:r,averageFieldLength:d,dirtCount:u,serializationVersion:h}=e;if(h!==1&&h!==2)throw new Error("MiniSearch: cannot deserialize an index created with an incompatible version");const c=new Q(t);return c._documentCount=n,c._nextId=i,c._idToShortId=new Map,c._fieldIds=r,c._avgFieldLength=d,c._dirtCount=u||0,c._index=new J,c}executeQuery(e,t={}){if(e===Q.wildcard)return this.executeWildcardQuery(t);if(typeof e!="string"){const _={...t,...e,queries:void 0},S=e.queries.map(k=>this.executeQuery(k,_));return this.combineResults(S,_.combineWith)}const{tokenize:n,processTerm:i,searchOptions:r}=this._options,d={tokenize:n,processTerm:i,...r,...t},{tokenize:u,processTerm:h}=d,w=u(e).flatMap(_=>h(_)).filter(_=>!!_).map(Vs(d)).map(_=>this.executeQuerySpec(_,d));return this.combineResults(w,d.combineWith)}executeQuerySpec(e,t){const n={...this._options.searchOptions,...t},i=(n.fields||this._options.fields).reduce((m,g)=>({...m,[g]:$e(n.boost,g)||1}),{}),{boostDocument:r,weights:d,maxFuzzy:u,bm25:h}=n,{fuzzy:c,prefix:p}={...gt.weights,...d},w=this._index.get(e.term),_=this.termResults(e.term,e.term,1,e.termBoost,w,i,r,h);let S,k;if(e.prefix&&(S=this._index.atPrefix(e.term)),e.fuzzy){const m=e.fuzzy===!0?.2:e.fuzzy,g=m<1?Math.min(u,Math.round(e.term.length*m)):m;g&&(k=this._index.fuzzyGet(e.term,g))}if(S)for(const[m,g]of S){const M=m.length-e.term.length;if(!M)continue;k?.delete(m);const q=p*m.length/(m.length+.3*M);this.termResults(e.term,m,q,e.termBoost,g,i,r,h,_)}if(k)for(const m of k.keys()){const[g,M]=k.get(m);if(!M)continue;const q=c*m.length/(m.length+M);this.termResults(e.term,m,q,e.termBoost,g,i,r,h,_)}return _}executeWildcardQuery(e){const t=new Map,n={...this._options.searchOptions,...e};for(const[i,r]of this._documentIds){const d=n.boostDocument?n.boostDocument(r,"",this._storedFields.get(i)):1;t.set(i,{score:d,terms:[],match:{}})}return t}combineResults(e,t=Je){if(e.length===0)return new Map;const n=t.toLowerCase(),i=Os[n];if(!i)throw new Error(`Invalid combination operator: ${t}`);return e.reduce(i)||new Map}toJSON(){const e=[];for(const[t,n]of this._index){const i={};for(const[r,d]of n)i[r]=Object.fromEntries(d);e.push([t,i])}return{documentCount:this._documentCount,nextId:this._nextId,documentIds:Object.fromEntries(this._documentIds),fieldIds:this._fieldIds,fieldLength:Object.fromEntries(this._fieldLength),averageFieldLength:this._avgFieldLength,storedFields:Object.fromEntries(this._storedFields),dirtCount:this._dirtCount,index:e,serializationVersion:2}}termResults(e,t,n,i,r,d,u,h,c=new Map){if(r==null)return c;for(const p of Object.keys(d)){const w=d[p],_=this._fieldIds[p],S=r.get(_);if(S==null)continue;let k=S.size;const m=this._avgFieldLength[_];for(const g of S.keys()){if(!this._documentIds.has(g)){this.removeTerm(_,g,t),k-=1;continue}const M=u?u(this._documentIds.get(g),t,this._storedFields.get(g)):1;if(!M)continue;const q=S.get(g),N=this._fieldLength.get(g)[_],U=Es(q,k,this._documentCount,N,m,h),W=n*i*w*M*U,j=c.get(g);if(j){j.score+=W,As(j.terms,e);const B=$e(j.match,t);B?B.push(p):j.match[t]=[p]}else c.set(g,{score:W,terms:[e],match:{[t]:[p]}})}}return c}addTerm(e,t,n){const i=this._index.fetch(n,bt);let r=i.get(e);if(r==null)r=new Map,r.set(t,1),i.set(e,r);else{const d=r.get(t);r.set(t,(d||0)+1)}}removeTerm(e,t,n){if(!this._index.has(n)){this.warnDocumentChanged(t,e,n);return}const i=this._index.fetch(n,bt),r=i.get(e);r==null||r.get(t)==null?this.warnDocumentChanged(t,e,n):r.get(t)<=1?r.size<=1?i.delete(e):r.delete(t):r.set(t,r.get(t)-1),this._index.get(n).size===0&&this._index.delete(n)}warnDocumentChanged(e,t,n){for(const i of Object.keys(this._fieldIds))if(this._fieldIds[i]===t){this._options.logger("warn",`MiniSearch: document with ID ${this._documentIds.get(e)} has changed before removal: term "${n}" was not present in field "${i}". Removing a document after it has changed can corrupt the index!`,"version_conflict");return}}addDocumentId(e){const t=this._nextId;return this._idToShortId.set(e,t),this._documentIds.set(t,e),this._documentCount+=1,this._nextId+=1,t}addFields(e){for(let t=0;t<e.length;t++)this._fieldIds[e[t]]=t}addFieldLength(e,t,n,i){let r=this._fieldLength.get(e);r==null&&this._fieldLength.set(e,r=[]),r[t]=i;const u=(this._avgFieldLength[t]||0)*n+i;this._avgFieldLength[t]=u/(n+1)}removeFieldLength(e,t,n,i){if(n===1){this._avgFieldLength[t]=0;return}const r=this._avgFieldLength[t]*n-i;this._avgFieldLength[t]=r/(n-1)}saveStoredFields(e,t){const{storeFields:n,extractField:i}=this._options;if(n==null||n.length===0)return;let r=this._storedFields.get(e);r==null&&this._storedFields.set(e,r={});for(const d of n){const u=i(t,d);u!==void 0&&(r[d]=u)}}}Q.wildcard=Symbol("*");const $e=(o,e)=>Object.prototype.hasOwnProperty.call(o,e)?o[e]:void 0,Os={[Je]:(o,e)=>{for(const t of e.keys()){const n=o.get(t);if(n==null)o.set(t,e.get(t));else{const{score:i,terms:r,match:d}=e.get(t);n.score=n.score+i,n.match=Object.assign(n.match,d),mt(n.terms,r)}}return o},[It]:(o,e)=>{const t=new Map;for(const n of e.keys()){const i=o.get(n);if(i==null)continue;const{score:r,terms:d,match:u}=e.get(n);mt(i.terms,d),t.set(n,{score:i.score+r,terms:i.terms,match:Object.assign(i.match,u)})}return t},[qs]:(o,e)=>{for(const t of e.keys())o.delete(t);return o}},Ts={k:1.2,b:.7,d:.5},Es=(o,e,t,n,i,r)=>{const{k:d,b:u,d:h}=r;return Math.log(1+(t-e+.5)/(e+.5))*(h+o*(d+1)/(o+d*(1-u+u*n/i)))},Vs=o=>(e,t,n)=>{const i=typeof o.fuzzy=="function"?o.fuzzy(e,t,n):o.fuzzy||!1,r=typeof o.prefix=="function"?o.prefix(e,t,n):o.prefix===!0,d=typeof o.boostTerm=="function"?o.boostTerm(e,t,n):1;return{term:e,fuzzy:i,prefix:r,termBoost:d}},Ue={idField:"id",extractField:(o,e)=>o[e],stringifyField:(o,e)=>o.toString(),tokenize:o=>o.split(Ds),processTerm:o=>o.toLowerCase(),fields:void 0,searchOptions:void 0,storeFields:[],logger:(o,e)=>{typeof console?.[o]=="function"&&console[o](e)},autoVacuum:!0},gt={combineWith:Je,prefix:!1,fuzzy:!1,maxFuzzy:6,boost:{},weights:{fuzzy:.45,prefix:.375},bm25:Ts},Ls={combineWith:It,prefix:(o,e,t)=>e===t.length-1},Re={batchSize:1e3,batchWait:10},We={minDirtFactor:.1,minDirtCount:20},je={...Re,...We},As=(o,e)=>{o.includes(e)||o.push(e)},mt=(o,e)=>{for(const t of e)o.includes(t)||o.push(t)},wt=({score:o},{score:e})=>e-o,bt=()=>new Map,ae=o=>{const e=new Map;for(const t of Object.keys(o))e.set(parseInt(t,10),o[t]);return e},le=async o=>{const e=new Map;let t=0;for(const n of Object.keys(o))e.set(parseInt(n,10),o[n]),++t%1e3===0&&await Ft(0);return e},Ft=o=>new Promise(e=>setTimeout(e,o)),Ds=/[\n\r\p{Z}\p{P}]+/u;var Ns=D('<p class="file-name svelte-xnoqic"> </p>'),$s=D('<div class="alert svelte-xnoqic"> </div>'),Us=D('<p class="status svelte-xnoqic"> </p>'),js=D("<option> </option>"),Ps=D('<button type="button" class="clear-filter svelte-xnoqic" aria-label="Clear book title filter">×</button>'),Rs=D("<option> </option>"),Ws=D('<button type="button" class="clear-filter svelte-xnoqic" aria-label="Clear author filter">×</button>'),Bs=D('<span>·</span> <button type="button" class="meta-link svelte-xnoqic"> </button>',1),Js=D("<span> </span>"),Qs=D("<span> </span>"),Ks=D("<span> </span>"),Hs=D('<article class="viewer-item svelte-xnoqic"><p class="viewer-content svelte-xnoqic"><!></p> <div class="viewer-meta svelte-xnoqic"><button type="button" class="meta-link svelte-xnoqic"> </button> <!> <!> <!> <!></div></article>'),Ys=D(`<p class="note svelte-xnoqic">Upload your Kindle clippings and browse by book or author. Everything stays local in your
    browser.</p> <section class="card viewer-card svelte-xnoqic"><div class="viewer-header svelte-xnoqic"><div><h2>Upload &amp; browse</h2></div></div> <div class="upload-panel svelte-xnoqic"><div class="upload-row svelte-xnoqic"><label class="file-input svelte-xnoqic" for="clippings"><input id="clippings" type="file" accept=".txt" class="svelte-xnoqic"/> <span>Choose &quot;My Clippings.txt&quot;</span></label> <span class="upload-or svelte-xnoqic">OR</span> <button type="button" class="ghost upload-alt svelte-xnoqic"> </button></div> <!> <p class="hint svelte-xnoqic">Your file never leaves the browser. Everything stays local.</p></div> <!> <!> <div class="viewer-actions svelte-xnoqic"><div class="action-card svelte-xnoqic"><button type="button" class="ghost svelte-xnoqic"> </button> <p class="action-help svelte-xnoqic">Stores your parsed clippings in this browser so they load automatically next time.</p></div> <div class="action-card svelte-xnoqic"><button type="button" class="ghost svelte-xnoqic">Clear saved data</button> <p class="action-help svelte-xnoqic">Removes the saved copy from this browser only. It does not change your file.</p></div></div> <div class="viewer-controls svelte-xnoqic"><label class="field field-wide svelte-xnoqic"><span class="svelte-xnoqic">Search</span> <input type="search" placeholder="Search titles, authors, or highlight text" class="svelte-xnoqic"/></label> <div class="field svelte-xnoqic"><span class="svelte-xnoqic">Book title</span> <div class="select-wrap svelte-xnoqic"><select class="svelte-xnoqic"><option>All titles</option><!></select> <!></div></div> <div class="field svelte-xnoqic"><span class="svelte-xnoqic">Author</span> <div class="select-wrap svelte-xnoqic"><select class="svelte-xnoqic"><option>All authors</option><!></select> <!></div></div> <label class="field svelte-xnoqic"><span class="svelte-xnoqic">Type</span> <select class="svelte-xnoqic"><option>All types</option><option>Highlight</option><option>Note</option></select></label> <label class="field svelte-xnoqic"><span class="svelte-xnoqic">Per page</span> <select class="svelte-xnoqic"><option>25</option><option>50</option><option>100</option></select></label> <div class="pager svelte-xnoqic"><button type="button" class="svelte-xnoqic">Previous</button> <span> </span> <button type="button" class="svelte-xnoqic">Next</button></div></div> <p class="viewer-count svelte-xnoqic"> </p> <div class="viewer-list svelte-xnoqic"></div></section>`,1);function fn(o,e){us(e,!1);let t=I([]),n=I(""),i=I(""),r=I(""),d=I(null),u=I(!1),h=I(!1),c=I(0),p=I(25),w=I([]),_=I(1),S=I(""),k=I("all"),m=I("all"),g=I("all"),M=I([]),q=I([]),N=I(null),U=I(new Map),W=I([]);async function j(l){const v=l.currentTarget.files?.[0];if(f(i,""),f(n,""),!v){f(t,[]),f(r,"");return}f(r,v.name);try{const z=await v.text(),C=_t(z);f(t,C.normalized.filter(K=>K.type!=="Bookmark")),s(t).length===0&&f(n,'No clippings found. Check that this is a Kindle "My Clippings.txt" file.')}catch(z){f(t,[]),f(n,z instanceof Error?z.message:"Something went wrong while parsing the file.")}}async function B(){f(h,!0),f(i,""),f(n,"");try{const l=await fetch("/My%20Clippings.txt");if(!l.ok)throw new Error("Unable to load the site clippings file.");const a=await l.text(),v=_t(a);f(t,v.normalized.filter(z=>z.type!=="Bookmark")),f(r,`Jon's "My Clippings.txt"`),s(t).length===0&&f(n,"No clippings found in the site file. Check the uploaded content.")}catch(l){f(t,[]),f(n,l instanceof Error?l.message:"Unable to load the site clippings file.")}finally{f(h,!1)}}function de(){return new Promise((l,a)=>{if(typeof indexedDB>"u"){a(new Error("IndexedDB is not available in this browser."));return}const v=indexedDB.open("kindle-clippings-viewer",1);v.onupgradeneeded=()=>{const z=v.result;z.objectStoreNames.contains("files")||z.createObjectStore("files")},v.onsuccess=()=>l(v.result),v.onerror=()=>a(v.error??new Error("Unable to open IndexedDB."))})}async function Ct(){try{const l=await de(),z=l.transaction("files","readonly").objectStore("files").get("default"),C=await new Promise((K,H)=>{z.onsuccess=()=>K(z.result??null),z.onerror=()=>H(z.error??new Error("Unable to read saved data."))});C?.normalized?.length&&(f(t,C.normalized),f(r,C.sourceFileName??""),f(i,"Loaded saved clippings from this browser.")),l.close()}catch(l){f(i,l instanceof Error?l.message:"Unable to load saved clippings.")}}async function Mt(){if(s(t).length){f(u,!0),f(i,"");try{const l=await de(),a=l.transaction("files","readwrite");a.objectStore("files").put({normalized:s(t),sourceFileName:s(r),savedAt:new Date().toISOString()},"default"),await new Promise((z,C)=>{a.oncomplete=()=>z(),a.onerror=()=>C(a.error??new Error("Unable to save clippings.")),a.onabort=()=>C(a.error??new Error("Unable to save clippings."))}),f(i,"Saved clippings to this browser."),l.close()}catch(l){f(i,l instanceof Error?l.message:"Unable to save clippings.")}finally{f(u,!1)}}}async function qt(){if(!(typeof window<"u"&&!window.confirm("Clear saved clippings from this browser and reset the current view? This cannot be undone."))){f(t,[]),f(r,""),f(c,0),f(i,"");try{const l=await de(),a=l.transaction("files","readwrite");a.objectStore("files").delete("default"),await new Promise((z,C)=>{a.oncomplete=()=>z(),a.onerror=()=>C(a.error??new Error("Unable to clear saved clippings.")),a.onabort=()=>C(a.error??new Error("Unable to clear saved clippings."))}),f(i,"Cleared saved clippings from this browser."),l.close()}catch(l){f(i,l instanceof Error?l.message:"Unable to clear saved clippings.")}}}function Ot(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Tt(l){return l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Et(l){if(!l)return"—";const a=Ot(l);if(!s(W).length)return a;const v=new RegExp(`(${s(W).map(Tt).join("|")})`,"gi");return a.replace(v,"<mark>$1</mark>")}hs(()=>{Ct(),typeof window<"u"&&new URLSearchParams(window.location.search).get("source")==="site"&&B()}),Te(()=>(s(t),s(m),s(g)),()=>{s(t);const l=new Set,a=new Set;for(const v of s(t))l.add(v.title?.trim()||"Untitled"),a.add(v.author?.trim()||"Unknown Author");f(M,Array.from(l).sort((v,z)=>v.localeCompare(z))),f(q,Array.from(a).sort((v,z)=>v.localeCompare(z))),s(m)!=="all"&&!l.has(s(m))&&f(m,"all"),s(g)!=="all"&&!a.has(s(g))&&f(g,"all"),s(m)!=="all"&&s(g)!=="all"&&f(g,"all"),f(c,0)}),Te(()=>(s(t),s(U),s(N),Q),()=>{if(s(t),f(U,new Map),s(t).length===0)f(N,null);else{const l=s(t).map((a,v)=>{const z=String(a.sourceIndex??v);return s(U).set(z,a),{id:z,title:a.title??"",author:a.author??"",content:a.content??"",type:a.type??"",groupTitle:a.title?.trim()||"Untitled",groupAuthor:a.author?.trim()||"Unknown Author"}});f(N,new Q({fields:["title","author","content"],storeFields:["id","title","author","type","groupTitle","groupAuthor"],searchOptions:{boost:{title:2,author:1.5},prefix:!0,fuzzy:.2}})),s(N).addAll(l)}}),Te(()=>(s(S),s(k),s(m),s(g),s(N),s(w),s(U),s(t),s(_),s(p),s(c)),()=>{s(S),s(k),s(m),s(g),s(N);const l=s(S).trim();if(f(W,l?l.split(/\s+/).map(a=>a.trim()).filter(a=>a.length>1):[]),l&&s(N)){const a=s(N).search(l,{filter:v=>!(s(k)!=="all"&&v.type!==s(k)||s(m)!=="all"&&v.groupTitle!==s(m)||s(g)!=="all"&&v.groupAuthor!==s(g))});f(w,a.map(v=>s(U).get(String(v.id))).filter(v=>!!v))}else f(w,s(t).filter(a=>!(s(k)!=="all"&&a.type!==s(k)||s(m)!=="all"&&(a.title?.trim()||"Untitled")!==s(m)||s(g)!=="all"&&(a.author?.trim()||"Unknown Author")!==s(g))));f(_,Math.max(1,Math.ceil(s(w).length/s(p)))),f(c,Math.min(s(c),s(_)-1))}),fs(),Ss();var Qe=Ys();ws("xnoqic",l=>{vs(()=>{_s.title="Kindle Clippings Viewer"})});var Ke=x(pt(Qe),2),ue=x(y(Ke),2),he=y(ue),fe=y(he),He=y(fe);ys(He,l=>f(d,l),()=>s(d)),re(2),b(fe);var X=x(fe,4),Vt=y(X,!0);b(X),b(he);var Lt=x(he,2);{var At=l=>{var a=Ns(),v=y(a);b(a),T(()=>L(v,`Selected: ${s(r)??""}`)),A(l,a)};R(Lt,l=>{s(r)&&l(At)})}re(2),b(ue);var Ye=x(ue,2);{var Dt=l=>{var a=$s(),v=y(a,!0);b(a),T(()=>L(v,s(n))),A(l,a)};R(Ye,l=>{s(n)&&l(Dt)})}var Ge=x(Ye,2);{var Nt=l=>{var a=Us(),v=y(a,!0);b(a),T(()=>L(v,s(i))),A(l,a)};R(Ge,l=>{s(i)&&l(Nt)})}var pe=x(Ge,2),ve=y(pe),ee=y(ve),$t=y(ee,!0);b(ee),re(2),b(ve);var Ze=x(ve,2),Ut=y(Ze);re(2),b(Ze),b(pe);var _e=x(pe,2),ge=y(_e),me=x(y(ge),2);bs(me),b(ge);var we=x(ge,2),Xe=x(y(we),2),G=y(Xe);T(()=>{s(m),Ee(()=>{s(t),s(M)})});var be=y(G);be.value=be.__value="all";var jt=x(be);Ve(jt,1,()=>s(M),vt,(l,a)=>{var v=js(),z=y(v,!0);b(v);var C={};T(()=>{L(z,s(a)),C!==(C=s(a))&&(v.value=(v.__value=s(a))??"")}),A(l,v)}),b(G);var Pt=x(G,2);{var Rt=l=>{var a=Ps();$("click",a,()=>f(m,"all")),A(l,a)};R(Pt,l=>{s(m)!=="all"&&l(Rt)})}b(Xe),b(we);var xe=x(we,2),et=x(y(xe),2),Z=y(et);T(()=>{s(g),Ee(()=>{s(t),s(m),s(q)})});var ye=y(Z);ye.value=ye.__value="all";var Wt=x(ye);Ve(Wt,1,()=>s(q),vt,(l,a)=>{var v=Rs(),z=y(v,!0);b(v);var C={};T(()=>{L(z,s(a)),C!==(C=s(a))&&(v.value=(v.__value=s(a))??"")}),A(l,v)}),b(Z);var Bt=x(Z,2);{var Jt=l=>{var a=Ws();T(()=>a.disabled=s(m)!=="all"),$("click",a,()=>f(g,"all")),A(l,a)};R(Bt,l=>{s(g)!=="all"&&l(Jt)})}b(et),b(xe);var Se=x(xe,2),te=x(y(Se),2);T(()=>{s(k),Ee(()=>{s(t)})});var ke=y(te);ke.value=ke.__value="all";var ze=x(ke);ze.value=ze.__value="Highlight";var tt=x(ze);tt.value=tt.__value="Note",b(te),b(Se);var Ie=x(Se,2),se=x(y(Ie),2),ne=y(se);ne.value=ne.__value="25";var ie=x(ne);ie.value=ie.__value="50";var Fe=x(ie);Fe.value=Fe.__value="100",b(se),b(Ie);var st=x(Ie,2),Ce=y(st),Me=x(Ce,2),Qt=y(Me);b(Me);var nt=x(Me,2);b(st),b(_e);var qe=x(_e,2),Kt=y(qe);b(qe);var it=x(qe,2);Ve(it,5,()=>(s(w),s(c),s(p),F(()=>s(w).slice(s(c)*s(p),(s(c)+1)*s(p)))),l=>l.sourceIndex,(l,a)=>{var v=Hs(),z=y(v),C=y(z);zs(C,()=>(s(a),F(()=>Et(s(a).content)))),b(z);var K=x(z,2),H=y(K),Ht=y(H,!0);b(H);var ot=x(H,2);{var Yt=E=>{var V=Bs(),P=x(pt(V),2),Oe=y(P,!0);b(P),T(()=>L(Oe,(s(a),F(()=>s(a).author)))),$("click",P,()=>{f(g,s(a).author?.trim()||"Unknown Author"),f(m,"all")}),A(E,V)};R(ot,E=>{s(a),F(()=>s(a).author)&&E(Yt)})}var rt=x(ot,2);{var Gt=E=>{var V=Js(),P=y(V);b(V),T(()=>L(P,`· ${s(a),F(()=>s(a).type)??""}`)),A(E,V)};R(rt,E=>{s(a),F(()=>s(a).type)&&E(Gt)})}var at=x(rt,2);{var Zt=E=>{var V=Qs(),P=y(V);b(V),T(Oe=>L(P,`· ${Oe??""}`),[()=>(s(a),F(()=>new Date(s(a).addedOn).toLocaleDateString()))]),A(E,V)};R(at,E=>{s(a),F(()=>s(a).addedOn)&&E(Zt)})}var Xt=x(at,2);{var es=E=>{var V=Ks(),P=y(V);b(V),T(()=>L(P,`· Loc ${s(a),F(()=>s(a).locationStart)??""}`)),A(E,V)};R(Xt,E=>{s(a),F(()=>s(a).locationStart)&&E(es)})}b(K),b(v),T(()=>L(Ht,(s(a),F(()=>s(a).title)))),$("click",H,()=>{f(m,s(a).title?.trim()||"Untitled"),f(g,"all")}),A(l,v)}),b(it),b(Ke),T(()=>{X.disabled=s(h),L(Vt,s(h)?"Loading...":"Browse my own personal highlights"),ee.disabled=(s(t),s(u),F(()=>!s(t).length||s(u))),L($t,s(u)?"Saving...":"Save"),me.disabled=(s(t),F(()=>!s(t).length)),G.disabled=(s(t),F(()=>!s(t).length)),Z.disabled=(s(t),s(m),F(()=>!s(t).length||s(m)!=="all")),te.disabled=(s(t),F(()=>!s(t).length)),se.disabled=(s(t),F(()=>!s(t).length)),Le(ne,s(p)===25),Le(ie,s(p)===50),Le(Fe,s(p)===100),Ce.disabled=(s(t),s(c),F(()=>!s(t).length||s(c)===0)),L(Qt,`Page ${s(c)+1} of ${s(_)??""}`),nt.disabled=(s(t),s(c),s(_),F(()=>!s(t).length||s(c)>=s(_)-1)),L(Kt,`${s(w),F(()=>s(w).length)??""} items`)}),$("change",He,j),$("click",X,B),$("click",ee,Mt),$("click",Ut,qt),xs(me,()=>s(S),l=>f(S,l)),Ae(G,()=>s(m),l=>f(m,l)),Ae(Z,()=>s(g),l=>f(g,l)),Ae(te,()=>s(k),l=>f(k,l)),$("change",se,l=>f(p,Number(l.currentTarget.value))),$("click",Ce,()=>f(c,Math.max(0,s(c)-1))),$("click",nt,()=>f(c,Math.min(s(_)-1,s(c)+1))),A(o,Qe),ps()}export{fn as component,hn as universal};
