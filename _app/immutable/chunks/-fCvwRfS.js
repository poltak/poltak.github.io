const l="==========",h=/^(.+?)(?:\s*\((.+)\))?\s*$/,p=/^-\s+Your\s+(.+?)\s+at\s+(.+)$/,g=/location\s+(\d+(?:-\d+)?)/i,w=/page\s+(\d+(?:-\d+)?)/i,R=/Added on\s+(.+)$/i,A={January:"01",February:"02",March:"03",April:"04",May:"05",June:"06",July:"07",August:"08",September:"09",October:"10",November:"11",December:"12"};function E(n){return n.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`)}function x(n){const t=n,s=n.replace(/^\ufeff/,"").trim(),e=s.match(h);if(!e)return{text:s,raw:t};const r=e[1].trim(),i=e[2]?e[2].trim():void 0;return{text:r,author:i,raw:t}}function y(n){const t=n.trim(),s=[],e=t.match(p);if(!e)return{type:t,raw:t,issues:["metadata-unmatched"]};const r=e[1].trim(),i=e[2],o=i.match(g),c=i.match(w),a=i.match(R);return!o&&!c&&s.push("missing-location-or-page"),{type:r,raw:t,rest:i,locationRaw:o?o[1]:void 0,pageRaw:c?c[1]:void 0,addedOnRaw:a?a[1].trim():void 0,issues:s}}function f(n){if(!n)return{};if(n.includes("-")){const[s,e]=n.split("-",2),r=Number(s),i=Number(e);return{start:Number.isFinite(r)?r:void 0,end:Number.isFinite(i)?i:void 0}}const t=Number(n);return Number.isFinite(t)?{start:t,end:t}:{}}function N(n){if(!n)return;const t=n.match(/^[A-Za-z]+,\s+(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})\s+(\d{2}):(\d{2}):(\d{2})$/);if(!t)return;const s=t[1].padStart(2,"0"),e=t[2],r=t[3],i=t[4],o=t[5],c=t[6],a=A[e];if(a)return`${r}-${a}-${s} ${i}:${o}:${c}`}function $(n){let t=0,s=n.lines.length;for(;t<s&&n.lines[t].trim()==="";)t+=1;for(;s>t&&n.lines[s-1].trim()==="";)s-=1;const e=n.lines.slice(t,s);if(e.length<2)return;const r=e[0],i=e[1];let o=e.slice(2);o.length>0&&o[0].trim()===""&&(o=o.slice(1));const c=x(r),a=y(i),d=o.join(`
`).trim(),u=d.length>0?d:void 0,m=[...a.issues];return!u&&a.type.toLowerCase().includes("highlight")&&m.push("highlight-missing-content"),{title:c,meta:a,content:u,raw:{titleLine:r,metaLine:i,contentLines:o},issues:m,sourceIndex:n.index}}function b(n){const t=n.replace(/^\ufeff/,""),s=E(t),e=[];let r=[],i=0;for(const o of s){if(o.trim()===l){r.length>0&&(e.push({index:i,lines:r,rawText:r.join(`
`)}),i+=1),r=[];continue}r.push(o)}return r.length>0&&e.push({index:i,lines:r,rawText:r.join(`
`)}),e}function M(n){const t=[];for(const s of n){const e=$(s);e&&t.push(e)}return t}function O(n){return n.map(t=>{const{start:s,end:e}=f(t.meta.locationRaw),{start:r,end:i}=f(t.meta.pageRaw),o=N(t.meta.addedOnRaw);return{title:t.title.text,author:t.title.author,type:t.meta.type,locationStart:s,locationEnd:e,pageStart:r,pageEnd:i,addedOn:o,content:t.content,rawMetadata:t.meta.raw,sourceIndex:t.sourceIndex}})}function T(n){const t=b(n),s=M(t),e=O(s);return{rawBlocks:t,parsed:s,normalized:e}}export{T as p};
